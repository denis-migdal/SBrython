<script src="../../brython/www/src/brython.js"></script>

<div class="editor">
    <div>
        <strong>Input</strong>
        <textarea id="python">log(1+1)</textarea>
    </div>
    <div>
        <strong>Output (SBryton)</strong>
        <pre class="output_sbrython"></pre>
    </div>
    <div>
        <strong>Output (Brython)</strong>
        <pre class="output_brython"></pre>
    </div>
    <div>
        <strong>Python code</strong>
        <pre class="python_ouput"></pre>
    </div>
    <div>
        <strong>Generated AST tree</strong>
        <pre id="ast"></pre>
    </div>
    <div>
        <strong>Generated JS code</strong>
        <pre id="js"></pre>
    </div>
</div>

<style>
    .editor {
        width: 100%;

        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        /*
        display: flex;
        align-items: flex-start;
        align-content: stretch;*/
        gap: 10px;

        & > div {

            /*flex: 1 1 0px;*/

            & > strong {
                display: block;
                width: 100%;
                text-align: center;
            }

            & > pre {
                border : 1px solid black;
                display: block;
                padding: 15px;
                margin: 0px;

                &.output_sbrython.success {
                    background-color: LightGreen;
                }
                &.output_sbrython.error {
                    background-color: OrangeRed;
                }
            }

            & > textarea {
                width: 100%;
                padding: 15px;
            }
        }

        & * > *:not(textarea) {
            border: 1px solid transparent;
        }

        & .highlight {
            background-color: yellow;

            & > * {
                background-color: orange;
                border: 1px solid black;
            }
        }
    }
</style>

<script type="module">
    import {py2ast, ast2js} from "../../dist/dev/index.js";

window.onerror = (...args) => {
	console.log(args);
	// msg
	// stack
	// 
}

//const $B = __BRYTHON__

const python_input = document.querySelector("#python");
const python_output = document.querySelector(".python_ouput");
const ast_output = document.querySelector("#ast");
const js_output = document.querySelector("#js");

const sbrython_output = document.querySelector(".output_sbrython");
const  brython_output = document.querySelector(".output_brython");

let prev_highlighted = null;

function highlight(target) {

    if( prev_highlighted === target)
        return;
    if( prev_highlighted !== null) {

        for(let gui_elem of prev_highlighted.$gui_elems)
            gui_elem.classList.remove("highlight");
        prev_highlighted = null;
    }

    const $node = target.$node;
    if( $node === undefined)
        return;

    prev_highlighted = $node;
    for(let gui_elem of $node.$gui_elems)
        gui_elem.classList.add("highlight");
}

ast_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})
python_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})
js_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})

function update() {
	const code = python_input.value;
    sbrython_output.textContent = "";
     brython_output.textContent = "";

    sbrython_output.classList.remove("success");
    sbrython_output.classList.remove("error");

    window.log = function(txt) { output += txt + "\n" };

    let output = "";
    let ast;
    let js_code;
    let beg = Date.now();
    try {
        ast = py2ast( code );
        js_code = ast2js(ast);
        const fct = new Function(js_code); //TODO args
        fct();
    } catch(e) {
        console.error(e); //TODO
    }
    let time = Date.now() - beg;
    let sbrython_result = output;
    let size = (100 * js_code.length / code.length - 100).toFixed(2);
    sbrython_output.textContent = `${output}\n**Executed in ${time}ms (code size +${size}%)**`;

    const code2 = `from window import log\n{code}`;
    let js_code2;
    beg = Date.now();
    try {
        js_code2 = $B.pythonToJS(code2);
        console.log(js_code2);
        const fct = new Function(js_code2); //TODO args
        fct();
    } catch(e) {
        console.error(e); //TODO
    }
    time = Date.now() - beg;
    let brython_result = output;
    size = (100 * js_code2.length / code.length - 100).toFixed(2);
    brython_output.textContent = `${output}\n**Executed in ${time}ms (code size +${size}%)**`;

    if( brython_result === sbrython_result )
        sbrython_output.classList.add("success");
    else
        sbrython_output.classList.add("error");

    print_python( code, ast );
	print_ast( ast );
	print_js( js_code, ast );
}

function print_node(node) {
    const html_bloc = document.createElement("div");
    html_bloc.$node = node;
    node.$gui_elems ??= [];
    node.$gui_elems.push( html_bloc );

    html_bloc.textContent = `${node.type}:${node.value}`;

	for(let child of node.children) {
        const html_child = print_node(child);
        html_child.style.setProperty("margin-left", "20px");
        html_bloc.append( html_child );
    }

	return html_bloc;
}

function print_ast(ast) {

    let lineid = 0;

    const nodes = ast.map( node => {

        const line = document.createElement("div");

        const lineno = document.createElement('span');
        lineno.textContent = `${++lineid}:`;

        lineno.style.setProperty("vertical-align", "top");
        lineno.style.setProperty("font-weight", "bold");
    
        line.append(lineno);

        const html = print_node(node);
        html.style.setProperty("display", "inline-block");
        line.append(html);


        return line;
    });
	ast_output.replaceChildren( ...nodes )

}

function slice_code(pycode, start_or_pos, end = null) {

    let start = start_or_pos;
    if(end === null) {
        ({start, end} = start_or_pos);
    }

    return pycode[start.line-1].slice( start.col, end.col );
}

function print_code_node(node, code, type) {
    
    const html_bloc = document.createElement("span");

    html_bloc.$node = node;
    node.$gui_elems ??= [];
    node.$gui_elems.push( html_bloc );

    let subparts = new Array(node.children.length * 2 + 1);
    let cursor = node[type].start;
    let offset = 0;
    for(let i = 0; i < node.children.length; ++i) {
        subparts[offset++] = slice_code(code, cursor, node.children[i][type].start);
        subparts[offset++] = print_code_node(node.children[i], code, type);
        cursor = node.children[i][type].end;
    }
    subparts[offset++] = slice_code(code, cursor, node[type].end);

    html_bloc.append(...subparts);

    return html_bloc;
}

// pycode or jscode
function print_code(code, ast, type) {

    let lineid = 0;

    code = code.split("\n");

    const nodes = ast.map( node => {

        const line = document.createElement("div");

        const lineno = document.createElement('span');
        lineno.textContent = `${++lineid}:`;

        lineno.style.setProperty("vertical-align", "top");
        lineno.style.setProperty("font-weight", "bold");
    
        line.append(lineno);

        //TODO: slice_code_here
        const html = print_code_node(node, code, type);
        html.style.setProperty("display", "inline-block");
        line.append(html);

        return line;
    });

    return nodes;
}

function print_python(pycode, ast) {
	python_output.replaceChildren( ...print_code(pycode, ast, "pycode") )
}

function print_js(jscode, ast) {
	js_output.replaceChildren( ...print_code(jscode, ast, "jscode") )
}

python_input.addEventListener("input",
							  () => update() )

update();

</script>