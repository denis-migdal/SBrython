<!DOCTYPE html>
<html>
    <head>

    </head>
<body>

<script src="../../brython/www/src/brython.js"></script>

<div class="editor">
    <div>
        <!-- log(1+1) -->
<!--

-->
        <strong>Input</strong>
        <textarea id="python">
# from browser import write
# For Brython compat:
from browser import window as _w_
write = _w_.write

# list/tuple
write([1,2])
write((1,2))
# []
# [] = 
# .append() => rewrite => push()

# f-string
write( f"{2}y" )
write( f"yy" )

# import
import browser
from browser import window as w

# try/except
try:
    raise Exception()
except Exception as e:
    write("caught")

def fee():
    raise Exception()

try:
    fee()
except Exception as e:
    write("caught2")

# fct dummy
def fii():
    return

# for range
for i in range(2):
    write(i)

for i in range(1, 2):
    write(i)

for i in range(0, 4, 2):
    write(i)

##fct
def foo(a:int,b:int) -> int:
    write(a+b)
foo(1,2)

def faa(a:int) -> int:
    return a

write(faa(4))

#TODO: with 2 args...

# while
h = True
while h:
    write("LOOP")
    h = False

# if / elif / else
if False:
    pass
else:
    write("ELSE")
    write("ELSE")

if False:
    pass
else:
    write("ELSE")


if False:
    pass
elif False:
    write("False")
    write("False")
elif True:
    write("True")
else:
    write("END")

#if pass
if True:
    pass

# str
write("")
write("ok")

# float
write(1.0)
write(1.2)

# Comments
if True: #End of line comment
    write(0)
0==0 #test
write(
    #test
    0
)
#None (implicit)
g: None = write(0)
# write(g     == None) expected to be true, not the case in Brython
write(   0  == g)
write(False == g)
write(   1  == g)
write(True  == g)

#None (explicit)

f = None
write(None)
write(None  == None)
write(   0  == None)
write(False == None)
write(   1  == None)
write(True  == None)

# decl
a = 2
write(a)
b = False
write(b)
d       = write(3)
e: None = write(3)

# operator.== (literals)
write(True == True)
write(False == False)
write(False == True)
write(False == 0)
write(True == 0)
write(False == 1)
write(True == 1)
write(False == 2)
write(True == 2)
write(0 == 0)
write(0 == 1)

# if boolean:
if False:
    write(0)
if True:
    write(True)
    write(False)
c = True
if c:
    write(3)
</textarea>
    </div>
    <div>
        <strong>Output (SBryton)</strong>
        <pre class="output_sbrython"></pre>
    </div>
    <div>
        <strong>Output (Brython)</strong>
        <pre class="output_brython"></pre>
    </div>
    <div>
        <strong>Python code</strong>
        <pre class="python_ouput"></pre>
    </div>
    <div>
        <strong>Generated AST</strong>
        <pre id="ast"></pre>
    </div>
    <div>
        <strong>Generated JS code</strong>
        <pre id="js"></pre>
    </div>
</div>

<style>

    body {
        width: 100vw;
        height: 100vh;
        margin:0px;
    }

    .success {
        background-color: LightGreen;
    }
    .error {
        background-color: OrangeRed;
    }

    .editor {
        width: 100%;
        height: 100%;

        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        /*
        display: flex;
        align-items: flex-start;
        align-content: stretch;*/
        gap: 10px;

        & > div {

            min-height: 0;
            /*flex: 1 1 0px;*/

            & > strong {
                display: block;
                width: 100%;
                text-align: center;
            }

            & > pre {
                border : 1px solid black;
                display: block;
                padding: 15px;
                margin: 0px;

                height: calc(100% - 1.5rem - 30px);
                overflow-y: auto;

                & > div {
                    min-height: 1rem;
                }
            }

            & > textarea {
                width: 100%;
                padding: 15px;

                height: calc(100% - 3.5rem);
                overflow-y: auto;
            }
        }

        & * > *:not(textarea) {
            border: 1px solid transparent;
        }

        & .highlight {
            background-color: yellow;

            & > * {
                background-color: orange;
                border: 1px solid black;
            }
        }
    }
</style>

<script type="module">
    import {py2ast, ast2js, convert_ast, parse_stack, stackline2astnode, SBrython} from "../../dist/dev/index.js";

    const SHOW_CODE_NODE_BEFORE_PRINT = false;

window.onerror = (...args) => {
	console.log(args);
	// msg
	// stack
	// 
}

//const $B = __BRYTHON__

const python_input = document.querySelector("#python");
const python_output = document.querySelector(".python_ouput");
const ast_output = document.querySelector("#ast");
const js_output = document.querySelector("#js");

const sbrython_output = document.querySelector(".output_sbrython");
const  brython_output = document.querySelector(".output_brython");

let prev_highlighted = null;

function highlight(target) {

    if( prev_highlighted === target)
        return;
    if( prev_highlighted !== null) {

        for(let gui_elem of prev_highlighted.$gui_elems)
            gui_elem.classList.remove("highlight");
        prev_highlighted = null;
    }

    const $node = target.$node;
    if( $node === undefined)
        return;

    prev_highlighted = $node;
    for(let gui_elem of $node.$gui_elems)
        gui_elem.classList.add("highlight");
}

brython_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})
sbrython_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})

ast_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})
python_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})
js_output.addEventListener("mouseover", ev => {
    highlight(ev.target);
})

function update() {
	const code = python_input.value;
    sbrython_output.textContent = "";
     brython_output.textContent = "";

    sbrython_output.classList.remove("success");
    sbrython_output.classList.remove("error");

    let is_sbrython = true;
    window.write = function(txt) {
        output.push([txt, new Error().stack]);
    };

    let output = [];
    let ast;
    let js_code = "";
    let beg = globalThis.performance.now();
    let step1;
    let step2;
    let step0;
    let _ast;
    let js_fct;
    let sb;

    const filename = "sbrython_editor.js";
    try {
        //ast = py2ast( code );
            const parser = new $B.Parser(code, filename, 'file');
            _ast = $B._PyPegen.run_parser(parser);

            step0 = globalThis.performance.now();
	        ast = {
                nodes: convert_ast(_ast),
                filename
            }
        step1 = globalThis.performance.now();
        js_code = ast2js(ast);
        step2 = globalThis.performance.now();
        sb = new SBrython()
        sb.runJSCode(js_code, ast);
    } catch(e) {
        console.error(e); //TODO
    }

    let sbrython_result = output.map( e => {
                const div = document.createElement('div')
                div.textContent = `${e[0]}`;
                div.raw = e[0];
                div.stack = e[1];
                return div;
            });
    try {
        console.log("AST", _ast);
        let end = globalThis.performance.now();
        let size = (100 * js_code.length / code.length - 100).toFixed(2);

        sbrython_output.replaceChildren(
            ...sbrython_result,

`**code size +${size}%**
**Executed in ${end-beg}ms**
    **Py2AST:  ${step0-beg}ms
    **ASTConv: ${step1-step0}ms
    **AST2JS:  ${step2-step1}ms
    **Runtime: ${end-step2}ms`
// **Py2AST:  ${step1-beg}ms

        );
    } catch(e) {}

    output = [];
    is_sbrython = false;
    //console.log("c2", code2);
    let js_code2;
    beg = globalThis.performance.now();
    try {
        js_code2 = $B.pythonToJS(code);
        /*
        const filename = "filename";
        const parser = new $B.Parser(code, filename, 'file');
	    const _ast = $B._PyPegen.run_parser(parser);
        step1 = globalThis.performance.now();

        var imported;
        var future = $B.future_features(_ast, filename)
        var symtable = $B._PySymtable_Build(_ast, filename, future)
        var js_obj = $B.js_from_root({ast: _ast,
                                    symtable,
                                    filename,
                                    src: code,
                                    imported})
        js_code2 = js_obj.js
        */

        //console.log(js_code2);
        step2 = globalThis.performance.now();
        const fct = new Function(js_code2); //TODO args
        fct();
    } catch(e) {
        console.error(e); //TODO
    }

    let brython_result = output.map( e => {
                const div = document.createElement('div')
                div.textContent = `${e[0]}`;
                div.raw = e[0];
                div.stack = e[1]
                return div;
            });
    try {
        let end = globalThis.performance.now();
        let size = (100 * js_code2.length / code.length - 100).toFixed(2);

        brython_output.replaceChildren(
            ...brython_result,
`**code size +${size}%**
**Executed in ${end-beg}ms**
    **Py2JS:   ${step2-beg}ms
    **Runtime: ${end-step2}ms`
    );

    /*
    **Py2AST:  ${step1-beg}ms
    **AST2JS:  ${step2-step1}ms*/
    } catch(e) {
        console.error(e);
    }

    function isNone(value) {
        return (typeof value === "object")
        && "__class__" in value
        && value.__class__.__qualname__ === "NoneType";
    }

    print_python( code, ast );
	print_ast( ast );
    console.log(js_code);
    //console.log(js_fct.toString());
    console.log(ast);
	print_js( js_code, ast );

    let equals = true;
    let min_id = Math.min(brython_result.length, sbrython_result.length)
    for(let i = 0; i < min_id; ++i) {

        const stackline = parse_stack(sbrython_result[i].stack, sb)[0];
        const node = stackline2astnode(stackline, sb);
        node.$gui_elems.push( sbrython_result[i], brython_result[i] );
        sbrython_result[i].$node = node;
         brython_result[i].$node = node;
        //TODO: in the other direction...

        let line_equals = true;

        if( sbrython_result[i].textContent !== brython_result[i].textContent )
            line_equals = false;
        if( typeof sbrython_result[i].raw !== typeof brython_result[i].raw ) {
            line_equals = false;

            if( typeof sbrython_result[i].raw === "bigint" && typeof brython_result[i].raw === "number")
                line_equals = true;
        }

        if( (sbrython_result[i].raw === null || sbrython_result[i].raw === undefined)
            && isNone(brython_result[i].raw) )
            line_equals = true;

        //if( ! line_equals )
        //    console.warn( typeof sbrython_result[i].raw, typeof brython_result[i].raw )

        let line_class = line_equals ? "success" : "error";
        sbrython_result[i].classList.add(line_class);
         brython_result[i].classList.add(line_class);

        if( ! line_equals )
            equals = false;
    }

    sbrython_output.classList.add(equals ? "success" : "error");

}

function print_node(node) {
    const html_bloc = document.createElement("div");
    html_bloc.$node = node;
    node.$gui_elems ??= [];
    node.$gui_elems.push( html_bloc );

    html_bloc.textContent = node.type;
    if( node.value != null)
        html_bloc.textContent += `:${node.value}`;
    if( node.result_type !== null)
    html_bloc.textContent += ` (${node.result_type})`;

	for(let child of node.children) {
        const html_child = print_node(child);
        html_child.style.setProperty("margin-left", "20px");
        html_bloc.append( html_child );
    }

	return html_bloc;
}

function print_ast(_ast) {

    let lineid = 0;

    const ast = _ast.nodes;

    const nodes = ast.map( node => {

        const line = document.createElement("div");

        const lineno = document.createElement('span');
        lineno.textContent = `${++lineid}:`;

        lineno.style.setProperty("vertical-align", "top");
        lineno.style.setProperty("font-weight", "bold");
    
        line.append(lineno);

        const html = print_node(node);
        html.style.setProperty("display", "inline-block");
        line.append(html);


        return line;
    });
	ast_output.replaceChildren( ...nodes )

}

function code_idx(code, {line, col}) {

    if(line === 1)
        return col;

    let cur = 0;
    let cur_line = 1;
    while( cur < code.length) {
        if( code[cur] === '\n' ) {
            ++cur_line;
            if( line === cur_line ) {
                ++cur;
                break;
            }
        }
        ++cur;
    }

    return cur + col;
}

function slice_code(code, start_or_pos, end = null) {

    let start = start_or_pos;
    if(end === null) {
        ({start, end} = start_or_pos);
    }

    let beg_idx = code_idx(code, start);
    let end_idx = code_idx(code,  end);

    return code.slice( beg_idx, end_idx );
}

function print_code_node(node, code, type) {
    
    if( SHOW_CODE_NODE_BEFORE_PRINT)
        console.log("N", node);

    const html_bloc = document.createElement("span");

    html_bloc.$node = node;
    node.$gui_elems ??= [];
    node.$gui_elems.push( html_bloc );

    let subparts = new Array(node.children.length * 2 + 1);
    let cursor = node[type].start;
    let offset = 0;
    for(let i = 0; i < node.children.length; ++i) {
        subparts[offset++] = slice_code(code, cursor, node.children[i][type].start);
        subparts[offset++] = print_code_node(node.children[i], code, type);
        cursor = node.children[i][type].end;
    }
    subparts[offset++] = slice_code(code, cursor, node[type].end);

    html_bloc.append(...subparts);

    return html_bloc;
}

// pycode or jscode
function print_code(code, _ast, type) {

    const ast = _ast.nodes;

    let lineid = 0;

    const nodes = ast.map( node => {

        const line = document.createElement("div");

        const lineno = document.createElement('span');
        lineno.textContent = `${++lineid}:`;

        lineno.style.setProperty("vertical-align", "top");
        lineno.style.setProperty("font-weight", "bold");
    
        line.append(lineno);

        //TODO: slice_code_here
        const html = print_code_node(node, code, type);
        html.style.setProperty("display", "inline-block");
        line.append(html);

        if(node.type !== "functions.def") //TODO...
            line.append(";");

        return line;
    });

    return nodes;
}

function print_python(pycode, ast) {
	python_output.replaceChildren( ...print_code(pycode, ast, "pycode") )
}

function print_js(jscode, ast) {
	js_output.replaceChildren( ...print_code(jscode, ast, "jscode") )
}

python_input.addEventListener("input",
							  () => update() )

update();

</script>
</body>
</html>